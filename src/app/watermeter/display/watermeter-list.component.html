<div class="app-container">
  <app-header></app-header>

  <div class="main-content-container">
    <app-sidebar></app-sidebar>

    <main class="content-area">
      <!-- Header Section -->
      <div class="content-header">
        <div class="header-content">
          <div class="title-section">
            <h2>
              <mat-icon class="header-icon">water</mat-icon>
              Water Meter Management
            </h2>
            <p class="subtitle">Monitor and manage all water meters across branches</p>
          </div>

          <!-- Search Bar -->
          <div class="search-section">
            <mat-form-field appearance="outline" class="search-field">
              <mat-label>Search water meters</mat-label>
              <input matInput placeholder="Search by serial number, status, or branch" 
                     [(ngModel)]="searchTerm" (input)="applyFilter()">
              <button mat-icon-button matSuffix *ngIf="searchTerm" (click)="clearSearch()">
                <mat-icon>close</mat-icon>
              </button>
              <mat-icon matPrefix>search</mat-icon>
            </mat-form-field>
          </div>

          <div class="create-container">
            <button mat-raised-button color="primary" class="create-button" (click)="goToCreate()">
              <mat-icon>add</mat-icon>
              Create New Water Meter
            </button>
          </div>
        </div>
      </div>

      <!-- Stats Overview -->
      <div class="stats-container">
        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-value">{{ getTotalMeters() }}</div>
            <div class="stat-label">Total Meters</div>
            <mat-icon class="stat-icon">water_drop</mat-icon>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-value">{{ getActiveMeters() }}</div>
            <div class="stat-label">Active Meters</div>
            <mat-icon class="stat-icon">check_circle</mat-icon>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-value">{{ getInactiveMeters() }}</div>
            <div class="stat-label">Inactive Meters</div>
            <mat-icon class="stat-icon">cancel</mat-icon>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card" *ngIf="searchTerm">
          <mat-card-content>
            <div class="stat-value">{{ getFilteredMeters() }}</div>
            <div class="stat-label">Matching Results</div>
            <mat-icon class="stat-icon">search</mat-icon>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Results Info -->
      <div class="results-info" *ngIf="searchTerm && branchMetersList.length > 0">
        <p>
          Showing {{ getFilteredMeters() }} of {{ getTotalMeters() }} meters 
          <span *ngIf="searchTerm">matching "{{ searchTerm }}"</span>
          <button mat-button color="primary" (click)="clearSearch()" *ngIf="searchTerm">
            Clear search
          </button>
        </p>
      </div>

      <!-- Branch Cards -->
      <div *ngIf="filteredBranchMetersList.length > 0; else emptyState">
        <div *ngFor="let branch of filteredBranchMetersList" class="branch-card">
          <div class="branch-header">
            <div class="branch-title">
              <mat-icon>business</mat-icon>
              <h3>Branch ID: {{ branch.branchId }}</h3>
              <span class="meter-count">({{ branch.meters.length }} meter{{ branch.meters.length !== 1 ? 's' : '' }})</span>
            </div>
            <button mat-icon-button class="expand-button" (click)="toggleBranch(branch.branchId)">
              <mat-icon>{{ isBranchExpanded(branch.branchId) ? 'expand_less' : 'expand_more' }}</mat-icon>
            </button>
          </div>

          <div *ngIf="isBranchExpanded(branch.branchId)" class="branch-content">
            <table mat-table [dataSource]="branch.meters" class="meter-table mat-elevation-z1">
              <!-- Serial Number Column -->
              <ng-container matColumnDef="serialNumber">
                <th mat-header-cell *matHeaderCellDef>
                  <mat-icon>confirmation_number</mat-icon> Serial Number
                </th>
                <td mat-cell *matCellDef="let meter" class="serial-number">
                  <mat-icon>tag</mat-icon>
                  {{ meter.serialNumber }}
                </td>
              </ng-container>

              <!-- Status Column -->
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>
                  <mat-icon>status</mat-icon> Status
                </th>
                <td mat-cell *matCellDef="let meter">
                  <span class="status-badge" [ngClass]="meter.status.toLowerCase()">
                    <mat-icon>{{ getStatusIcon(meter.status) }}</mat-icon>
                    {{ meter.status }}
                  </span>
                </td>
              </ng-container>

              <!-- Installation Date Column -->
              <ng-container matColumnDef="installationDate">
                <th mat-header-cell *matHeaderCellDef>
                  <mat-icon>event</mat-icon> Installation Date
                </th>
                <td mat-cell *matCellDef="let meter">
                  {{ meter.installationDate | date:'mediumDate' }}
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="actions-header">
                  <mat-icon>settings</mat-icon> Actions
                </th>
                <td mat-cell *matCellDef="let meter" class="actions-cell">
                  <button mat-icon-button color="primary" (click)="editMeter(meter.id)" matTooltip="Edit meter">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button color="warn" (click)="deleteMeter(meter.id)" matTooltip="Delete meter">
                    <mat-icon>delete</mat-icon>
                  </button>
                  <button mat-icon-button color="accent" matTooltip="View details">
                    <mat-icon>visibility</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <ng-template #emptyState>
        <mat-card class="empty-state-card">
          <mat-card-content>
            <div class="empty-state">
              <mat-icon *ngIf="!searchTerm">water_drop</mat-icon>
              <mat-icon *ngIf="searchTerm">search_off</mat-icon>
              <h3>{{ searchTerm ? 'No matching water meters found' : 'No water meters found' }}</h3>
              <p>{{ searchTerm ? 'No meters match your search for "' + searchTerm + '"' : 'Get started by adding your first water meter' }}</p>
              <button mat-raised-button color="primary" (click)="goToCreate()">
                <mat-icon>add</mat-icon>
                {{ searchTerm ? 'Clear search and create' : 'Create First Water Meter' }}
              </button>
              <button mat-button color="primary" (click)="clearSearch()" *ngIf="searchTerm">
                <mat-icon>clear</mat-icon>
                Clear search
              </button>
            </div>
          </mat-card-content>
        </mat-card>
      </ng-template>
    </main>
  </div>

  <app-footer></app-footer>
</div>