<div class="app-container">
  <app-header></app-header>

  <div class="main-content-container">
    <app-sidebar></app-sidebar>

    <main class="content-area">
      <!-- Header Section -->
      <div class="content-header">
        <div class="header-content">
          <div class="title-section">
            <button mat-icon-button class="back-button" (click)="goBack()">
              <mat-icon>arrow_back</mat-icon>
            </button>
            <div>
              <h2><mat-icon class="header-icon">show_chart</mat-icon> Water Consumption Analytics</h2>
              <p class="subtitle" *ngIf="branchId">Visualizing water usage for Branch ID: {{branchId}}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Statistics Overview -->
      <div class="stats-container" *ngIf="waterConsumptions.length > 0">
        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-value">{{ getTotalConsumption() | number:'1.2-2' }}</div>
            <div class="stat-label">Total Consumption (m³)</div>
            <mat-icon class="stat-icon">water_drop</mat-icon>
          </mat-card-content>
        </mat-card>
        
        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-value">{{ getAverageConsumption() | number:'1.2-2' }}</div>
            <div class="stat-label">Average (m³)</div>
            <mat-icon class="stat-icon">avg_pace</mat-icon>
          </mat-card-content>
        </mat-card>
        
        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-value">{{ getMeterCount() }}</div>
            <div class="stat-label">Meters Tracked</div>
            <mat-icon class="stat-icon">sensors</mat-icon>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card">
          <mat-card-content>
            <div class="stat-value">{{ getReadingCount() }}</div>
            <div class="stat-label">Total Readings</div>
            <mat-icon class="stat-icon">list_alt</mat-icon>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Date Range Selector -->
      <mat-card class="filter-card" *ngIf="waterConsumptions.length > 0">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>date_range</mat-icon>
            Date Range
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="date-filters">
            <mat-form-field appearance="outline">
              <mat-label>Start Date</mat-label>
              <input matInput [matDatepicker]="startPicker" [(ngModel)]="startDate" (dateChange)="filterData()">
              <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
              <mat-datepicker #startPicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>End Date</mat-label>
              <input matInput [matDatepicker]="endPicker" [(ngModel)]="endDate" (dateChange)="filterData()">
              <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
              <mat-datepicker #endPicker></mat-datepicker>
            </mat-form-field>

            <button mat-stroked-button (click)="resetFilters()">
              <mat-icon>refresh</mat-icon>
              Reset Filters
            </button>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Chart Card -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>bar_chart</mat-icon>
            Water Consumption Trend
          </mat-card-title>
          <mat-card-subtitle>
            {{ waterConsumptions.length > 0 ? 'Cubic meters consumption over time' : 'Loading consumption data...' }}
          </mat-card-subtitle>
        </mat-card-header>
        
        <mat-card-content>
          <div class="chart-container">
            <canvas id="waterChart"></canvas>
          </div>

          <!-- Data Table -->
          <div class="data-table-container" *ngIf="waterConsumptions.length > 0">
            <h3>Consumption Data</h3>
            <table mat-table [dataSource]="waterConsumptions" class="consumption-table">
              <!-- Date Column -->
              <ng-container matColumnDef="readingDate">
                <th mat-header-cell *matHeaderCellDef>Date</th>
                <td mat-cell *matCellDef="let item">{{ item.readingDate | date:'medium' }}</td>
              </ng-container>

              <!-- Consumption Column -->
              <ng-container matColumnDef="cubicMeters">
                <th mat-header-cell *matHeaderCellDef>Consumption (m³)</th>
                <td mat-cell *matCellDef="let item">{{ item.cubicMeters | number:'1.2-2' }}</td>
              </ng-container>

              <!-- Meter Column -->
              <ng-container matColumnDef="meter">
                <th mat-header-cell *matHeaderCellDef>Meter</th>
                <td mat-cell *matCellDef="let item">
                  {{ item.meterSerialNumber || item.meterId || 'N/A' }}
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="['readingDate', 'cubicMeters', 'meter']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['readingDate', 'cubicMeters', 'meter'];"></tr>
            </table>
          </div>

          <!-- Empty State -->
          <div class="empty-state" *ngIf="waterConsumptions.length === 0">
            <mat-icon>show_chart</mat-icon>
            <h3>No consumption data available</h3>
            <p>There is no water consumption data for this branch</p>
          </div>
        </mat-card-content>
      </mat-card>
    </main>
  </div>

  <app-footer></app-footer>
</div>